{% load static %}
<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mfumo wa Usajili wa Washirika - Kanisa</title>
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="church-logo">
          <img src="{% static 'images/background.jpg' %}" alt="Church Logo" class="logo-image">
        </div>
        <div class="church-info">
          <h1 class="church-name">JEHOVAH-NISSI BIBLE FELLOWSHIP MINISTRY</h1>
          <p class="church-subtitle">
            Mfumo wa Usajili wa Washirika
            {% if current_branch %} - {{ current_branch.name }}{% endif %}
          </p>
        </div>
      </div>
      <nav class="navigation">
        <a href="{% url 'home' %}" class="nav-link active">Nyumbani</a>
        
        <!-- Registration link available to all users -->
        <a href="{% url 'member-signup' %}" class="nav-link">Sajili</a>
        
        {% if user.is_authenticated %}
          <!-- Authenticated user menu -->
          <a href="{% url 'member-directory' %}" class="nav-link">Orodha</a>
          {% if user.profile and user.profile.can_manage_attendance %}
            <a href="/admin/membership/attendancesession/" class="nav-link">Mahudhurio</a>
          {% endif %}
          {% if user.profile and user.profile.can_manage_news %}
            <a href="/admin/membership/news/" class="nav-link">Habari</a>
          {% endif %}
          {% if user.profile and user.profile.role == 'admin' or user.is_superuser %}
            <a href="{% url 'authentication:admin_dashboard' %}" class="nav-link">Utawala</a>
          {% endif %}
          <div class="user-menu">
            <span class="user-greeting">Karibu, {{ user.get_full_name|default:user.username }}!</span>
            {% if user.profile and user.profile.primary_branch %}
              <span class="user-branch">{{ user.profile.primary_branch.name }}</span>
            {% endif %}
            <a href="{% url 'authentication:member_profile' %}" class="nav-link">Wasifu</a>
            <a href="{% url 'authentication:logout' %}" class="nav-link logout-link">Toka</a>
          </div>
        {% else %}
          <!-- Guest user menu -->
          <a href="{% url 'authentication:login' %}" class="nav-link login-link">Ingia</a>
        {% endif %}
      </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-content">
        <h2>Karibu Katika Familia ya JBF</h2>
        <p>Mfumo wa kisasa wa usajili wa washirika unaokusaidia kudumisha taarifa za washirika kwa urahisi na usalama.</p>
        <div class="hero-actions">
          <a href="{% url 'member-signup' %}" class="btn btn-primary">
            📝 Sajili Mshirika Mpya
          </a>
          <a href="{% url 'member-directory' %}" class="btn btn-secondary">
            📋 Ona Orodha ya Washirika
          </a>
        </div>
      </div>
    </section>

    <!-- Branch Selector (for users with multiple branches) -->
    {% if user.is_authenticated and user_branches|length > 1 %}
    <div class="branch-selector">
      <h3>Chagua Tawi</h3>
      <div class="branch-cards">
      {% for branch in user_branches %}
      <div class="branch-card {% if branch == current_branch %}active{% endif %}" 
           data-branch-id="{{ branch.id }}" 
           onclick="selectBranch({{ branch.id }}, '{{ branch.name }}')"
           style="cursor: pointer;">
        <div class="branch-info">
          <h4>{{ branch.name }}</h4>
          <p>{{ branch.code }} - Washirika</p>
        </div>
      </div>
      {% endfor %}
      </div>
      
      <!-- Branch Statistics -->
      {% if branches_with_stats %}
      <div class="branch-stats">
        <h4>Takwimu za Matawi</h4>
        <div class="branch-stats-grid">
          {% for branch in branches_with_stats %}
          <div class="branch-stat-card">
            <h5>{{ branch.name }}</h5>
            <div class="mini-stats">
              <span>{{ branch.total_members }} Washirika</span>
              <span>{{ branch.new_this_month }} Wapya</span>
              <span>{{ branch.baptized }} Wamebatizwa</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <section class="statistics">
      <h3>Takwimu za Ushirika{% if current_branch %} - {{ current_branch.name }}{% endif %}</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">👥</div>
          <div class="stat-content">
            <h4>{{ stats.total_members|default:0 }}</h4>
            <p>Jumla ya Washirika</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">🆕</div>
          <div class="stat-content">
            <h4>{{ stats.new_members_this_month|default:0 }}</h4>
            <p>Washirika Wapya Mwezi Huu</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">💧</div>
          <div class="stat-content">
            <h4>{{ stats.baptized_members|default:0 }}</h4>
            <p>Waliobatizwa</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">🎓</div>
          <div class="stat-content">
            <h4>{{ stats.membership_class_completed|default:0 }}</h4>
            <p>Waliokamilisha Darasa</p>
          </div>
        </div>
      </div>

      <!-- Branch-specific statistics for multi-branch users -->
      {% if branch_stats and user_branches|length > 1 %}
      <div class="branch-stats">
        <h4>Takwimu za Matawi</h4>
        <div class="branch-stats-grid">
          {% for branch_id, stats in branch_stats.items %}
          <div class="branch-stat-card">
            <h5>{{ stats.name }} ({{ stats.code }})</h5>
            <div class="mini-stats">
              <span>👥 {{ stats.total_members }}</span>
              <span>🆕 {{ stats.new_this_month }}</span>
              <span>💧 {{ stats.baptized }}</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </section>

    <!-- Recent News Section -->
    {% if recent_news %}
    <section class="recent-news">
      <h3>Habari za Hivi Karibuni</h3>
      <div class="news-grid">
        {% for news in recent_news %}
        <div class="news-card priority-{{ news.priority }}">
          <div class="news-header">
            <h4>{{ news.title }}</h4>
            <span class="news-scope">
              {% if news.scope == 'general' %}🌍 Jumla{% else %}🏢 {{ news.branch.name }}{% endif %}
            </span>
          </div>
          <p class="news-content">{{ news.content|truncatewords:20 }}</p>
          <div class="news-meta">
            <span class="news-date">{{ news.publish_date|date:"d M Y" }}</span>
            {% if news.category %}
            <span class="news-category" style="background-color: {{ news.category.color }}">
              {{ news.category.name }}
            </span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- Features Section -->
    <section class="features">
      <h3>Huduma za Mfumo</h3>
      <div class="features-grid">
        <div class="feature-card">
          <div class="feature-icon">📝</div>
          <h4>Usajili wa Haraka</h4>
          <p>Fomu rahisi ya usajili yenye uthibitishaji wa moja kwa moja na maelezo ya makosa.</p>
          {% if user.is_authenticated %}
            <a href="{% url 'member-signup' %}" class="feature-link">Sajili Mshirika Mpya →</a>
          {% else %}
            <a href="{% url 'authentication:login' %}" class="feature-link">🔑 Ingia Kwanza →</a>
          {% endif %}
        </div>
        
        <div class="feature-card">
          <div class="feature-icon">🔍</div>
          <h4>Utafutaji wa Kina</h4>
          <p>Tafuta washirika kwa jina, namba ya simu, au taarifa nyingine yoyote.</p>
          {% if user.is_authenticated %}
            <a href="{% url 'member-directory' %}" class="feature-link">Fungua Orodha →</a>
          {% else %}
            <a href="{% url 'authentication:login' %}" class="feature-link">🔑 Ingia Kwanza →</a>
          {% endif %}
        </div>
        
        <div class="feature-card">
          <div class="feature-icon">📊</div>
          <h4>Takwimu za Kina</h4>
          <p>Ona takwimu za washirika, makundi ya umri, na taarifa za kiroho.</p>
          <a href="{% url 'member-directory' %}" class="feature-link">Ona Takwimu →</a>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon">📱</div>
          <h4>Mfumo wa Simu</h4>
          <p>Mfumo unaofanya kazi vizuri kwenye simu, kompyuta ndogo na kompyuta kubwa.</p>
          <a href="#" class="feature-link">Jifunze Zaidi →</a>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon">🔒</div>
          <h4>Usalama wa Hali ya Juu</h4>
          <p>Taarifa za washirika zinachukuliwa kwa uangalifu mkubwa na usalama wa hali ya juu.</p>
          <a href="#" class="feature-link">Sera ya Faragha →</a>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon">📄</div>
          <h4>Uhamishaji wa Taarifa</h4>
          <p>Hamisha orodha ya washirika katika mfumo wa CSV kwa matumizi mengine.</p>
          <a href="{% url 'member-directory' %}" class="feature-link">Hamisha →</a>
        </div>
        
        <!-- New Multi-Branch Features -->
        {% if user.is_authenticated and user.profile.can_manage_attendance %}
        <div class="feature-card">
          <div class="feature-icon">📋</div>
          <h4>Mahudhurio ya Ibada</h4>
          <p>Rekodi na fuatilia mahudhurio ya washirika katika ibada mbalimbali.</p>
          <a href="/admin/membership/attendancesession/" class="feature-link">Mahudhurio →</a>
        </div>
        {% endif %}
        
        {% if user.is_authenticated and user.profile.can_manage_news %}
        <div class="feature-card">
          <div class="feature-icon">📰</div>
          <h4>Habari na Matangazo</h4>
          <p>Chapisha habari za tawi au za jumla kwa washirika wote.</p>
          <a href="/admin/membership/news/" class="feature-link">Habari →</a>
        </div>
        {% endif %}
        
        {% if branches|length > 1 %}
        <div class="feature-card">
          <div class="feature-icon">🏢</div>
          <h4>Matawi ya Kanisa</h4>
          <p>Mfumo unasaidia matawi {{ branches|length }} ya kanisa kwa utawala wa kando.</p>
          <a href="/admin/membership/branch/" class="feature-link">Matawi →</a>
        </div>
        {% endif %}
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions">
      <h3>Vitendo vya Haraka</h3>
      <div class="actions-grid">
        <a href="{% url 'member-signup' %}" class="action-card">
          <div class="action-icon">➕</div>
          <div class="action-content">
            <h4>Ongeza Mshirika</h4>
            <p>Sajili mshirika mpya</p>
          </div>
        </a>
        
        <a href="{% url 'member-directory' %}" class="action-card">
          <div class="action-icon">👀</div>
          <div class="action-content">
            <h4>Ona Washirika</h4>
            <p>Angalia orodha kamili</p>
          </div>
        </a>
        
        <a href="/admin/" class="action-card">
          <div class="action-icon">⚙️</div>
          <div class="action-content">
            <h4>Utawala</h4>
            <p>Mipangilio ya mfumo</p>
          </div>
        </a>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <div class="footer-section">
          <h4>Kuhusu Mfumo</h4>
          <p>Mfumo wa kisasa wa usajili wa washirika wa kanisa unaotumia teknolojia ya Django na JavaScript.</p>
        </div>
        
        <div class="footer-section">
          <h4>Mawasiliano</h4>
          <p>📧 jbf.arusha@gmail.com</p>
          <p>📞 +255 795 208 394</p>
          <p>📍 Arusha, Tanzania</p>
        </div>
        
        <div class="footer-section">
          <h4>Viungo Muhimu</h4>
          <ul>
            <li><a href="{% url 'member-signup' %}">Sajili</a></li>
            <li><a href="{% url 'member-directory' %}">Orodha</a></li>
            <li><a href="/admin/">Utawala</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; {{ current_year|default:"2024" }} Jehovah-Nissi Bible Fellowship Ministry. Haki zote zimehifadhiwa.</p>
      </div>
    </footer>
  </div>

  <script src="{% static 'js/home.js' %}"></script>
</body>
</html>
